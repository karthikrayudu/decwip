using Azure;
using Azure.AI.DocumentIntelligence;
using Form1065Extractor.Models;

namespace Form1065Extractor.Services
{
    public class AzureFormRecognizerService
    {
        private readonly DocumentIntelligenceClient _client;

        public AzureFormRecognizerService(IConfiguration configuration)
        {
            var endpoint = configuration["AzureFormRecognizer:Endpoint"];
            var key = configuration["AzureFormRecognizer:Key"];

            if (string.IsNullOrEmpty(endpoint) || string.IsNullOrEmpty(key))
                throw new Exception("Azure Form Recognizer configuration is missing");

            _client = new DocumentIntelligenceClient(
                new Uri(endpoint),
                new AzureKeyCredential(key)
            );
        }

        public async Task<Form1065Data> ExtractDataAsync(Stream fileStream)
        {
            var operation = await _client.AnalyzeDocumentAsync(
                WaitUntil.Completed,
                "prebuilt-document",
                BinaryData.FromStream(fileStream)
            );

            var result = operation.Value;
            var doc = result.Documents.First();

            return new Form1065Data
            {
                PartnershipName = doc.Fields.GetValueOrDefault("NameOfPartnership")?.Content ?? "",
                EIN = doc.Fields.GetValueOrDefault("EIN")?.Content ?? "",
                StreetAddress = doc.Fields.GetValueOrDefault("Address")?.Content ?? "",
                CityStateZip = doc.Fields.GetValueOrDefault("CityStateZip")?.Content ?? "",
                BusinessCodeNumber = doc.Fields.GetValueOrDefault("BusinessCodeNumber")?.Content ?? "",
                TotalAssets = decimal.TryParse(
                    doc.Fields.GetValueOrDefault("TotalAssets")?.Content,
                    out var assets) ? assets : 0,
                ApplicableBoxes = "",
                TaxYear = DateTime.UtcNow.Year,
                CreatedAt = DateTime.UtcNow,
                UpdatedAt = DateTime.UtcNow
            };
        }
    }
}
